openapi: 3.1.0

info:
  title: Client Subscriptions API
  version: 1.0.0
  description: API for managing client subscriptions and their event notifications.

servers:
  - url: https://api.example.com

security:
  - bearerAuth: []

paths:

  /clientSubscriptions:
    post:
      summary: Create a new client subscription
      operationId: createClientSubscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientSubscriptionRequest'
      responses:
        '201':
          description: Client subscription created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '400':
          description: Invalid request payload
        '401':
          description: Unauthorized – missing or invalid JWT token
        '409':
          description: Conflict – a similar subscription already exists

    get:
      summary: Get all clientSubscriptions grouped by their subscription items
      operationId: listClientSubscriptions
      responses:
        '200':
          description: List of clientSubscriptions with subscriptions array
          content:
            application/json:
              schema:
                type: object
                properties:
                  subscriptions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Subscription'
        '401':
          description: Unauthorized – invalid JWT token

  /clientSubscriptions/{clientSubscriptionId}:
    get:
      summary: Get all subscription objects for the given clientSubscriptionId
      operationId: getClientSubscription
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Subscription list for given clientSubscriptionId
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientSubscription'
        '401':
          description: Unauthorized
        '404':
          description: Not found

    put:
      summary: Update all subscription entries for the clientSubscriptionId (bulk update)
      operationId: updateClientSubscription
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                subscriptions:
                  type: array
                  items:
                    $ref: '#/components/schemas/SubscriptionRequest'
      responses:
        '200':
          description: Updated subscription list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientSubscription'
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
        '404':
          description: Not found

    delete:
      summary: Delete all subscriptions under this clientSubscriptionId
      operationId: deleteClientSubscription
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted
        '401':
          description: Unauthorized
        '404':
          description: Not found

  /clientSubscriptions/{clientSubscriptionId}/subscriptions:
    post:
      summary: Create a new subscription for a clientSubscriptionId
      operationId: createSubscription
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscriptionRequest'
      responses:
        '201':
          description: Subscription created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
        '404':
          description: Not found

    get:
      summary: List all subscriptions under clientSubscriptionId
      operationId: listSubscriptions
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Subscription list
          content:
            application/json:
              schema:
                type: object
                properties:
                  subscriptions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Subscription'
        '401':
          description: Unauthorized
        '404':
          description: Not found

  /clientSubscriptions/{clientSubscriptionId}/subscriptions/{subscriptionId}:
    get:
      summary: Get single subscription
      operationId: getSubscription
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: subscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Subscription object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '401':
          description: Unauthorized
        '404':
          description: Not found

    put:
      summary: Update subscription
      operationId: updateSubscription
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: subscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscriptionRequest'
      responses:
        '200':
          description: Updated subscription
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
        '404':
          description: Not found

    delete:
      summary: Delete subscription
      operationId: deleteSubscription
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: subscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted
        '401':
          description: Unauthorized
        '404':
          description: Not found

components:

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    EventType:
      type: string
      enum:
        - PCR
        - CUSTODIAL_RESULT

    HttpsWebhookUrl:
      type: string
      format: uri
      pattern: '^https://.*$'

    ClientSubscription:
      type: object
      description: Container with top-level subscriptions array
      properties:
        subscriptions:
          type: array
          items:
            $ref: '#/components/schemas/Subscription'

    ClientSubscriptionRequest:
      type: object
      required:
        - eventType
        - webhookUrl
      properties:
        eventType:
          $ref: '#/components/schemas/EventType'
        webhookUrl:
          $ref: '#/components/schemas/HttpsWebhookUrl'

    SubscriptionRequest:
      type: object
      required:
        - eventType
        - webhookUrl
      properties:
        eventType:
          $ref: '#/components/schemas/EventType'
        webhookUrl:
          $ref: '#/components/schemas/HttpsWebhookUrl'

    Subscription:
      type: object
      properties:
        clientSubscriptionId:
          type: string
          format: uuid
        eventType:
          $ref: '#/components/schemas/EventType'
        webhookUrl:
          $ref: '#/components/schemas/HttpsWebhookUrl'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
